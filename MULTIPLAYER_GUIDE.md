# 局域网联机使用指南

本文档详细说明如何使用《剑魄》游戏的局域网联机功能。

## 快速开始

### 第一步：确保所有玩家在同一局域网

所有想要一起游戏的玩家必须连接到同一个 WiFi 网络或通过网线连接到同一个路由器。

### 第二步：选择一台电脑作为服务器

选择一台电脑作为游戏服务器（推荐网络状况最好的电脑）。

### 第三步：在服务器电脑上启动服务

在服务器电脑上打开终端/命令行，进入项目目录，运行：

```bash
npm run server
```

你会看到类似这样的输出：

```
WebSocket 服务器运行在端口 3001
局域网地址: http://YOUR_LOCAL_IP:3001
```

### 第四步：获取服务器 IP 地址

**Windows 系统：**

1. 按 `Win + R`，输入 `cmd`，按回车
2. 输入 `ipconfig` 并按回车
3. 找到 "IPv4 地址"，例如 `192.168.1.100`

**Mac 系统：**

1. 打开终端
2. 输入 `ifconfig | grep "inet " | grep -v 127.0.0.1`
3. 找到类似 `192.168.1.100` 的地址

**Linux 系统：**

1. 打开终端
2. 输入 `ip addr show | grep "inet " | grep -v 127.0.0.1`
3. 找到类似 `192.168.1.100` 的地址

### 第五步：启动游戏客户端

在所有参与游戏的电脑上（包括服务器电脑），运行：

```bash
npm run dev
```

然后在浏览器中打开 `http://localhost:5173`

### 第六步：连接并开始游戏

**房主（创建房间）：**

1. 点击主菜单的"局域网对战"按钮
2. 输入服务器地址（例如 `http://192.168.1.100:3001`）
3. 点击"连接服务器"
4. 点击"创建房间"
5. 将显示的 6 位房间 ID 告诉你的朋友
6. 等待对手加入后，点击"准备"

**加入者：**

1. 点击主菜单的"局域网对战"按钮
2. 输入服务器地址（与房主相同）
3. 点击"连接服务器"
4. 输入房主提供的 6 位房间 ID
5. 点击"加入房间"
6. 等待房主准备，游戏自动开始

## 常见问题

### Q: 无法连接到服务器？

**A:** 请检查：
1. 服务器是否正在运行（`npm run server`）
2. 防火墙是否允许端口 3001 的连接
3. IP 地址是否输入正确
4. 所有设备是否在同一局域网内

### Q: 如何允许防火墙通过？

**Windows:**
1. 打开 Windows 防火墙设置
2. 点击"允许应用通过防火墙"
3. 点击"更改设置"，然后"允许其他应用"
4. 添加 Node.js 或允许端口 3001

**Mac:**
1. 系统偏好设置 > 安全性与隐私 > 防火墙
2. 点击"防火墙选项"
3. 添加 Node.js 应用

**Linux:**
```bash
sudo ufw allow 3001
sudo ufw allow 5173
```

### Q: 游戏延迟很高怎么办？

**A:**
1. 确保使用有线网络连接（而非 WiFi）
2. 关闭其他占用网络带宽的应用（下载、视频等）
3. 尝试更换性能更好的电脑作为服务器
4. 减少同时运行的后台程序

### Q: 可以通过互联网联机吗？

**A:** 目前版本只支持局域网联机。如需互联网联机，需要进行以下配置：

1. 在路由器上设置端口转发（Port Forwarding），将端口 3001 转发到服务器电脑
2. 使用公网 IP 地址（可通过访问 https://whatismyipaddress.com 获取）
3. 其他玩家输入 `http://你的公网IP:3001` 连接

**注意：** 公网联机可能涉及网络安全问题，请谨慎使用。

## 技术细节

### 网络架构

```
玩家 A 客户端 (浏览器)
        ↓
    Vite 开发服务器 (5173)
        ↓
WebSocket 服务器 (3001) ← 玩家 B 客户端
        ↓
    房间管理系统
```

### 同步的数据

- 玩家位置和速度（每 50ms）
- 攻击动作（实时）
- 冲刺/技能使用（实时）
- 击中判定（实时）
- 回合结束和得分（实时）

### 端口说明

- **3001** - WebSocket 服务器端口（需要开放）
- **5173** - Vite 开发服务器（本地访问）

## 性能优化建议

1. **使用有线连接** - 有线网络比 WiFi 更稳定
2. **服务器选择** - 使用性能较好的电脑作为服务器
3. **减少网络负载** - 游戏时避免下载、视频等
4. **关闭不必要的程序** - 释放更多 CPU 和内存资源

## 故障排除步骤

如果遇到问题，请按以下顺序检查：

1. **检查网络连接**
   ```bash
   ping 服务器IP地址
   ```

2. **检查服务器状态**
   - 确认 `npm run server` 正在运行
   - 查看控制台是否有错误信息

3. **检查防火墙**
   - 临时关闭防火墙测试（之后记得重新开启）
   - 或添加例外规则

4. **重启服务**
   - 停止服务器（Ctrl+C）
   - 重新运行 `npm run server`

5. **清除缓存**
   - 关闭所有浏览器标签页
   - 清除浏览器缓存
   - 重新打开游戏

## 联系与反馈

如果您在使用过程中遇到问题或有改进建议，欢迎提交 Issue 或 Pull Request。

祝您游戏愉快！ ⚔️
